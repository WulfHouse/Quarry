# Quarry Lockfile Format and Workflow

## What is Quarry.lock?

`Quarry.lock` is a lockfile that ensures reproducible builds by pinning exact versions of all dependencies. It is automatically generated by `quarry resolve` and should be committed to version control.

## Lockfile Format

The lockfile is a TOML file with the following structure:

```toml
[dependencies]
foo = "1.0.0"
bar = "2.1.0"
baz = "3.0.0"
```

Each entry maps a dependency name to its exact resolved version. These versions satisfy the constraints specified in `Quarry.toml`.

## Workflow

### Initial Setup

1. **Add dependencies to Quarry.toml**:
   ```toml
   [dependencies]
   foo = ">=1.0.0"
   bar = "2.0.0"
   ```

2. **Resolve dependencies**:
   ```bash
   quarry resolve
   ```
   This reads `Quarry.toml`, resolves version constraints to specific versions, and generates `Quarry.lock`.

3. **Commit both files**:
   ```bash
   git add Quarry.toml Quarry.lock
   git commit -m "Add dependencies"
   ```

### Updating Dependencies

#### Update All Dependencies

To update all dependencies to their latest compatible versions:

```bash
quarry update
```

This re-resolves all dependencies from `Quarry.toml` and updates `Quarry.lock` with new versions that still satisfy the constraints.

#### Update Specific Package

To update only one package:

```bash
quarry update --package foo
```

This updates only `foo` to the latest version compatible with its constraint in `Quarry.toml`.

### Building with Lockfile

#### Normal Build (Auto-Resolve)

If `Quarry.lock` is missing, `quarry build` will automatically resolve dependencies:

```bash
quarry build
```

This is convenient for development but not recommended for CI/CD.

#### Locked Build (Reproducible)

For reproducible builds (especially in CI/CD), use the `--locked` flag:

```bash
quarry build --locked
```

This flag:
- **Requires** `Quarry.lock` to exist
- **Validates** that locked versions satisfy constraints in `Quarry.toml`
- **Fails** if lockfile is missing or outdated
- **Ensures** reproducible builds across environments

If validation fails, you'll see:
```
Error: Quarry.lock is outdated. Dependency 'foo' in Quarry.toml not found in lockfile.
Run 'quarry resolve' to update Quarry.lock
```

## Version Constraints

Quarry supports the following version constraint formats:

- **Exact version**: `"1.0.0"` - requires exactly this version
- **Greater than or equal**: `">=1.0.0"` - requires version >= 1.0.0
- **Pessimistic**: `"~>1.0"` - requires version >= 1.0.0 and < 2.0.0
- **Wildcard**: `"*"` - allows any version (resolves to latest)

## Examples

### Adding a Dependency

1. Edit `Quarry.toml`:
   ```toml
   [dependencies]
   new_lib = ">=1.0.0"
   ```

2. Resolve:
   ```bash
   quarry resolve
   ```

3. Lockfile is updated:
   ```toml
   [dependencies]
   new_lib = "2.0.0"
   ```

### Updating a Dependency

1. Edit `Quarry.toml` to change constraint:
   ```toml
   [dependencies]
   foo = ">=2.0.0"  # Changed from >=1.0.0
   ```

2. Update lockfile:
   ```bash
   quarry update
   ```

3. Lockfile is updated with new version:
   ```toml
   [dependencies]
   foo = "2.0.0"  # Updated from 1.0.0
   ```

### CI/CD with Lockfile

In CI/CD pipelines, always use `--locked`:

```yaml
# .github/workflows/ci.yml
- name: Build
  run: quarry build --locked
```

This ensures:
- Builds are reproducible
- Dependencies don't change unexpectedly
- Failures are caught if lockfile is outdated

## Best Practices

1. **Always commit Quarry.lock**: This ensures all developers and CI use the same dependency versions.

2. **Use `--locked` in CI/CD**: Prevents unexpected dependency updates from breaking builds.

3. **Update regularly**: Run `quarry update` periodically to get security updates and bug fixes.

4. **Review changes**: When updating, review what changed in `Quarry.lock` to understand impact.

5. **Test after updates**: After updating dependencies, run your test suite to ensure compatibility.

## Troubleshooting

### Lockfile Outdated

**Error**: `Quarry.lock is outdated`

**Solution**: Run `quarry resolve` to regenerate the lockfile.

### Missing Lockfile

**Error**: `Quarry.lock not found`

**Solution**: 
- For development: Run `quarry build` (auto-resolves)
- For CI/CD: Run `quarry resolve` first, then commit lockfile

### Version Conflict

**Error**: `Cannot resolve dependency 'foo' with constraint '>=2.0.0'`

**Solution**: 
- Check if the constraint is too restrictive
- Verify the package exists in the registry
- Try a different version constraint

## Related Commands

- `quarry resolve` - Resolve dependencies and generate lockfile
- `quarry update` - Update lockfile with latest compatible versions
- `quarry build --locked` - Build with lockfile validation
- `quarry build` - Build (auto-resolves if lockfile missing)

## Related Documentation

- [Quarry Build System](README.md)
- [Dependency Management](../dependency-management.md)
