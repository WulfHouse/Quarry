---
alwaysApply: true
---
**SSOT:** `docs/specification/technical-ssot.md` (FROZEN Dec 23, 2025)
**Structure:** REQ-IDs → SPEC-IDs (NODE=grouping, LEAF=atomic work unit)
**Command Prefix (MANDATORY):** `& "C:\Program Files\Git\bin\bash.exe" scripts/run_gates.sh`

---

## 0. AGENT STATE (CRITICAL - UPDATE AFTER EACH SPEC)

### 0.1 Current State (LIVE - UPDATE THIS)

```yaml
Last updated: December 23, 2025
Milestone: M10 | Last SPEC: SPEC-LANG-0840 | Next: SPEC-LANG-0841
Commit: 61abb48 "CHECKPOINT: M10 SPEC-LANG-0840 verified+complete"
Phase: 3 (Beta) | Status: READY | Branch: 1.2.0-alpha
Tests: [To be verified] | Notes: SPEC-LANG-0840 complete, JSON/TOML formats implemented
```

### 0.2 State History (Last 5)
```
1. 2025-12-23 M10 SPEC-LANG-0840→SPEC-LANG-0841 | SPEC-LANG-0840 complete
2. 2025-12-23 M9 SPEC-LANG-0822→M10 SPEC-LANG-0840 | M0-M9 complete
3-5. [Date] M[X] SPEC-[ID]→SPEC-[ID] | [Notes]
```

### 0.3 Session Startup (DO THIS FIRST)
```
1. READ Section 0.1 → Note "Next" SPEC
2. VERIFY: git log -1 --pretty=format:"%s" matches "Last SPEC"
3. If mismatch: git log --grep="CHECKPOINT:" -1 → Update 0.1 → Commit "STATE: Synchronized"
4. LOCATE SPEC in technical-ssot.md → Read DoD, deps, tests
5. GO: Implement → Test → CHECKPOINT → Update 0.1 → STATE commit
```

### 0.4 Update Template (After Each SPEC)
```yaml
Last updated: [YYYY-MM-DD]
Milestone: M[X] | Last SPEC: SPEC-[COMP]-[NUM] | Next: SPEC-[COMP]-[NUM]
Commit: [7-char sha] "CHECKPOINT: M[X] SPEC-[COMP]-[NUM] verified+complete"
Phase: [0-4] ([Name]) | Status: READY | Branch: [name]
Tests: [X/1813] (full) OR [X/457] (fast) | Notes: [Context]
```

### 0.5 Control Commands
- **"GO"** (all caps) = Start/resume work immediately (no confirmation)

---

## 1. CORE WORKFLOW

### 1.1 LEAF SPEC (Atomic Unit)
```
Step 1: IMPLEMENT (satisfy all DoD criteria, handle edge cases, add diagnostics)
Step 2: TEST (unit+integration+golden+perf per "Tests required")
Step 3: VERIFY (run full suite, fix until 100% pass, never skip tests)
Step 4: CHECKPOINT (git add . && git commit -m "CHECKPOINT: M[X] SPEC-[COMP]-[NUM] verified+complete")
Step 5: UPDATE STATE (edit Section 0.1 with new state)
Step 6: STATE COMMIT (git add .cursor/rules/unified-workflow.mdc && git commit -m "STATE: Updated after M[X] SPEC-[COMP]-[NUM]")
```

### 1.2 NODE SPEC (Container)
```
1. Review "Children:" list → Identify LEAFs/sub-NODEs
2. Implement each child (LEAF workflow) in dependency order
3. Verify integration → Full test suite → Final commit
```

### 1.3 Dual-Commit Pattern (MANDATORY)
**Every SPEC = 2 commits:** CHECKPOINT (code+tests) + STATE (Section 0.1 update)
**Why:** Git history tracks both implementation + navigation metadata

---

## 2. TESTING (NEVER SKIP)

### 2.1 When to Test
✅ Before commit | ✅ Before marking todo complete | ✅ After SPEC done | ✅ After bug fix

### 2.2 Commands
```powershell
# Fast (dev iteration): ~457 tests, ~8s
& "C:\Program Files\Git\bin\bash.exe" scripts/run_gates.sh python tools/testing/pytest_fast.py

# Full (pre-commit): 1813+ tests
& "C:\Program Files\Git\bin\bash.exe" scripts/run_gates.sh pytest tests/
```

### 2.3 Failure Protocol
IF test fails → HALT → Analyze (impl bug vs test bug) → Fix (never modify SSOT) → Re-run → Repeat until 100% pass

### 2.4 Coverage Targets
Forge: 100% (critical paths) | Pyrite: 90%+ | Quarry: 80%+

---

## 3. PROJECT STRUCTURE

```
Quarry/
├── docs/specification/technical-ssot.md  # SSOT (frozen)
├── forge/src/                            # Stage0 Python compiler
├── pyrite/                               # Standard library
├── quarry/                               # Build system + pkg manager
├── scripts/run_gates.sh                  # Quality gates (mandatory prefix)
├── tests/                                # unit/ integration/ acceptance/
└── .agent-artifacts/                     # Agent temp files (.txt only)
```

**Code Locations:** Lexer: `forge/src/frontend/lexer.py` | Parser: `forge/src/frontend/parser.py` | TypeChecker: `forge/src/middle/type_checker.py` | Codegen: `forge/src/backend/codegen.py` | Stdlib: `pyrite/stdlib/src/` | Quarry: `quarry/main.py`

---

## 4. MILESTONES (technical-ssot.md Section 8.1)

**Phase 0 (Foundations):** M0 Lexical | M1 Diagnostics
**Phase 1 (Self-hosting):** M2 Parsing | M3 Types | M4 Build
**Phase 2 (Alpha):** M5 Advanced Types | M6 Ownership | M7 Codegen | M8 Build Orchestration
**Phase 3 (Beta):** M9 Stdlib Core | M10 Extended Stdlib | M11 DbC | M12 REPL/Docs
**Phase 4 (Stabilization):** M13 Perf Tools | M14 Concurrency | M15 Security

**Milestone Map:**
- M0: SPEC-LANG-0002..0020, SPEC-FORGE-0002
- M1: SPEC-FORGE-0001,0101..0110
- M2: SPEC-LANG-0101..0120,0009..0015, SPEC-FORGE-0009..0018
- M3: SPEC-LANG-0201..0247, SPEC-FORGE-0019..0023
- M4: SPEC-QUARRY-0001,0010..0018,0021..0024,0026
- M5: SPEC-LANG-0204,0205, SPEC-FORGE-0005
- M6: SPEC-LANG-0300..0316, SPEC-FORGE-0006
- M7: SPEC-FORGE-0024..0029,0205,0206,0008, SPEC-LANG-0501..0508
- M8: SPEC-QUARRY-0004..0006,0014,0019,0020
- M9: SPEC-LANG-0800,0801,0820..0838,0815
- M10: SPEC-LANG-0804,0840,0841,0805,0850,0806,0870..0873
- M11: SPEC-LANG-0401..0409,0510,0511,0807,1101..1104,1201,1203,1501, SPEC-FORGE-0201..0209
- M12: SPEC-QUARRY-0201..0205,0007,0025,0030,0033..0035,0401..0406,0501..0505, SPEC-LANG-1301,1302
- M13: SPEC-QUARRY-0101..0115,0036, SPEC-LANG-0601..0605,0807..0810,0901..0903, SPEC-FORGE-0305..0308
- M14: SPEC-LANG-1000..1005
- M15: SPEC-QUARRY-0300..0308

---

## 5. DEFINITION OF DONE (DoD)

**SPEC incomplete until ALL checked:**
- [ ] All DoD bullets implemented
- [ ] User-facing behavior met exactly
- [ ] Edge cases handled (logic/errors)
- [ ] Failure modes + diagnostics (error codes)
- [ ] All tests (per "Tests required") written + passing
- [ ] Examples (positive+negative) work
- [ ] Code in correct files (per "Implementation notes")
- [ ] Dependencies satisfied

---

## 6. ERROR HANDLING

**Format:** `error[P####]` (P=Pyrite, ####=unique number)
**Required Components:**
1. WHAT (description)
2. WHY (safety/correctness issue)
3. NEXT (actionable suggestions, multiple options)
4. LOCATION (multi-line source with highlighting)

**Example:**
```
error[P0123]: Cannot borrow `x` as mutable (already borrowed immutable)
  --> src/main.pyrite:15:9
14 |     let ref1 = &x;           // immutable borrow
15 |     let ref2 = &mut x;       // ^^^^^^ error here
16 |     use_ref(ref1);
help: Restructure to avoid overlapping borrows
help: Clone `x`: `x.clone()`
```

---

## 7. COMMIT PATTERNS

**Format (MANDATORY):** `CHECKPOINT: M[num] SPEC-[COMP]-[ID] verified+complete`
- [num]: M0..M15
- [COMP]: LANG | FORGE | QUARRY
- [ID]: 4-digit (e.g., 0110)

**Good:** Atomic, tested, includes SPEC-ID+milestone
**Bad:** Multiple SPECs, partial work, failing tests
**Branches:** `spec/m[X]-[component]-[number]` for experimental work

---

## 8. WORKFLOWS (Quick Reference)

| Pattern | Flow |
|---------|------|
| Single SPEC | git log → Sec 0 → Read SPEC → Verify deps → Impl → Test → CHECKPOINT → Update Sec 0 → STATE → Report |
| Milestone | git log → Sec 0 → List SPECs → For each: impl+test+CHECKPOINT+Sec0+STATE → Report |
| Bug Fix | Identify → Find SPEC → Fix → Test → Commit "BUGFIX: [SPEC-ID] - [desc]" |
| Missing Req | Document gap → Notify user → Don't proceed without clarification |

---

## 9. FORBIDDEN ACTIONS (NEVER)

1. ❌ Modify technical-ssot.md to bypass tests (SSOT is frozen/authoritative)
2. ❌ Commit with failing tests (100% pass required)
3. ❌ Skip run_gates.sh prefix (quality gates mandatory)
4. ❌ Work on SPEC with unsatisfied deps (dependency order architectural)
5. ❌ Assume unclear requirements (ask user, check Section 10)
6. ❌ Commit partial SPEC work (complete DoD or don't commit)
7. ❌ Modify git config or force push (respect history)

---

## 10. CODE QUALITY

**Style (REQ-173):** 4 spaces | 100 char max | `snake_case` (vars/funcs) | `CamelCase` (types) | `#` or `"""` comments

---

## 11. TECHNICAL-SSOT.MD REFERENCE

**Key Sections:** 0 (Meta) | 2 (REQ→SPEC) | 4-6 (SPECs) | 7 (Testing) | 8.1 (Milestones) | 11 (Release) | 12 (Alignment)

**SPEC Schema:** Kind (LEAF/NODE) | Source (REQs) | Status | Priority | DoD | Behavior | Semantics | Edge cases | Diagnostics | Examples | Implementation | Dependencies | Tests | (NODE: Children + Ordering)

**May Update:** Status after completion | LEAF→NODE reclassification | New SPEC-IDs (with approval)
**Never Update:** DoD changes | Test removals | REQ mods | Milestone reassignments

---

## 12. SPEC-ID NAMING

```
SPEC-[COMPONENT]-[NUMBER]
LANG: 0000-0099 Lexical | 0100-0199 Expressions | 0200-0299 Types | 0300-0399 Ownership
      0400-0499 Advanced | 0500-0599 Closures | 0600-0699 SIMD | 0700-0799 GPU
      0800-0899 Stdlib | 0900-0999 Memory | 1000-1099 Concurrency | 1100-1199 Observability
      1200-1299 FFI | 1300-1399 Docs | 1500-1599 Formal
FORGE: 0000-0099 Pipeline | 0100-0199 Diagnostics | 0200-0299 Passes | 0300-0399 Optimization
QUARRY: 0000-0099 Build | 0100-0199 Perf | 0200-0299 Interactive | 0300-0399 Security
        0400-0499 Ecosystem | 0500-0599 LSP
```

---

## 13. ADVANCED PATTERNS

**Parallel Work:** SPECs without mutual deps → separate branches
**Dep Chains:** Build graph → topological sort → implement in order
**Circular Deps:** Report immediately (specification error, don't proceed)
**LEAF→NODE:** If LEAF too complex → Stop → Relabel NODE → Decompose 2-7 sub-LEAFs → Commit "SPEC-REWORK: SPEC-[ID] relabeled"

---

## 14. FAILURE RECOVERY

| Issue | Action |
|-------|--------|
| Test Fails | Read test → Compare DoD → Fix → Re-run → Repeat |
| Blocked Dep | Find SPEC-ID → Check status → Implement (PLANNED) or complete (PARTIAL) |
| Unclear SPEC | Check impl notes → Sec 10 → Similar SPECs → Ask user |
| Regression | Git diff → Identify change → Fix interaction → Refactor if needed |
| Corrupted Sec 0 | `git log --grep="CHECKPOINT:" -1` → Parse → Rebuild 0.1 → Commit "STATE: Rebuilt" |

---

## 15. MILESTONE-SPECIFIC GUIDELINES

**M0-M1:** Unicode handling, indentation tracking, error codes
**M2-M3:** Operator precedence, pattern matching, type unification
**M6:** Field-level tracking, lifetime bounds, re-borrowing logic
**M7:** IR generation, calling conventions, closure layouts
**M9-M15:** Borrow-by-default (REQ-268), bounds checking, error handling

---

## 16. REPORTING

**Progress:** Report SPEC-ID | Milestone | Impl summary | Files | Tests (X/Y) | Commit hash | Next SPEC
**Blockers:** Report SPEC-ID | Reason | Unmet deps | Recommendation
**Interaction:** Proactive | Report after each SPEC | Ask when blocked | Suggest improvements

---

## 17. CONTEXT OPTIMIZATION

**1M Token Limit:** Auto-refresh → TODOs+git persist → Resume via `git log` + Section 0
**Optimize:** Don't re-read full SSOT | Use `grep` for SPEC-IDs | Cache milestone structure

---

## 18. SUCCESS CRITERIA

### Per-SPEC
✅ All DoD met | ✅ Tests written+passing | ✅ Edge cases handled | ✅ Style compliant | ✅ 1813+ tests pass | ✅ CHECKPOINT commit | ✅ Section 0 updated | ✅ STATE commit | ✅ No regressions

### Per-Milestone
✅ All SPEC-IDs complete | ✅ Acceptance checks pass | ✅ Integration verified | ✅ All tests pass | ✅ CHECKPOINT final SPEC | ✅ Deps satisfied

### Per-Phase (Release)
✅ All milestones done | ✅ Release checklist (Sec 11.1/11.2) | ✅ Cross-platform verified | ✅ No critical bugs | ✅ Docs updated | ✅ Perf benchmarks met

---

## 19. QUICK COMMANDS

```powershell
# Startup
git log -1 --pretty=format:"%s"                                        # Verify state

# Testing
& "C:\Program Files\Git\bin\bash.exe" scripts/run_gates.sh python tools/testing/pytest_fast.py  # Fast
& "C:\Program Files\Git\bin\bash.exe" scripts/run_gates.sh pytest tests/                        # Full

# Commits (after tests pass)
git add [files]
git commit -m "CHECKPOINT: M[X] SPEC-[COMP]-[NUM] verified+complete"
# Edit Section 0.1
git add .cursor/rules/unified-workflow.mdc
git commit -m "STATE: Updated agent resume state after M[X] SPEC-[COMP]-[NUM]"

# Utils
git status && git branch                                              # Check status
```

---

## 20. DECISION TREE

```
START: User assigns work
├─ SPEC impl? → YES → Read SPEC → Deps satisfied? → NO: Do deps first | YES: Continue
│                  → LEAF? → YES: Impl→Test→Commit | NO (NODE): Children in order → DONE
├─ Bug fix? → YES → Fix→Test→Commit "BUGFIX: [SPEC-ID] - [desc]"
├─ New feature? → YES → SPEC exists? → YES: Follow SPEC | NO: Ask user
└─ Else → CLARIFY with user
END: Report completion or blocker
```

---

## 21. SPECIAL CONSIDERATIONS

**Cross-Platform:** `pathlib`, cross-platform libs | Targets: Windows (primary), Linux, macOS
**Bootstrap:** Stage0 (Python, current) → Stage1 (Pyrite) → Stage2 (self-hosted) | Work on Stage0
**SSOT Gap:** Status: EXISTS-TODAY (verify+extend) | PARTIAL (complete) | PLANNED (implement) | See Sec 12
**Agent Files:** `.agent-artifacts/` only | Reports: .txt (markdown .md FORBIDDEN) | Cleanup before commit

---

## 22. COMMON ERROR PATTERNS

| Pattern | SPEC | Error | Fix |
|---------|------|-------|-----|
| Use-After-Move | SPEC-LANG-0301 | error[P0101] | Clone before move or use borrowing |
| Borrow Conflict | SPEC-LANG-0307 | error[P0201] | Restructure scope, use split borrowing |
| Type Inference Fail | SPEC-LANG-0201 | error[P0301] | Add explicit type annotation |

---

## 23. CRITICAL REMINDERS

**Three Mandatory Actions Per SPEC:**
1. ✅ CHECKPOINT commit (code+tests)
2. ✅ STATE update (edit Section 0.1)
3. ✅ STATE commit (persist metadata)

**Unbreakable Rules:**
1. NEVER commit without passing tests
2. NEVER skip dual-commit pattern
3. ALWAYS update Section 0 after each SPEC
4. ALWAYS read Section 0 at session start
5. ALWAYS prefix commands with run_gates.sh

**Most Common Mistake:** Forgetting to update Section 0 after committing → breaks continuity!
