# M9 Map Stress Test

import std.collections.map

extern "C" fn atoi(s: *const u8) -> int
extern "C" fn strcmp(s1: *const u8, s2: *const u8) -> i32

fn main(argc: int, argv: *const *const u8) -> int:
    var iterations = 1000  # Default smoke scale
    
    # Simple argument parsing
    var i = 1
    while i < argc:
        unsafe:
            let arg = argv[i]
            if strcmp(arg, "--scale" as *u8) == 0:
                if i + 1 < argc:
                    iterations = atoi(argv[i + 1])
                    i = i + 1
            elif strcmp(arg, "--n" as *u8) == 0:
                if i + 1 < argc:
                    iterations = atoi(argv[i + 1])
                    i = i + 1
        i = i + 1
    
    print("Starting Map stress test with scale:", iterations)
    
    var my_map: Map[int, int] = Map.new()
    
    # Insert values
    var j = 0
    while j < iterations:
        my_map.insert(j, j * 2)
        if j % 10000 == 0 and j > 0:
            print("Progress: Inserted", j, "items")
        j = j + 1
    
    print("Inserted items.")
    
    # Verify values
    var success = true
    var k = 0
    while k < iterations:
        let expected = k * 2
        let val = my_map.get(k)
        
        if val != expected:
            print("Error: Value mismatch for key", k, ": expected", expected, "got", val)
            success = false
            break # Exit on first error for stress test
        
        if k % 10000 == 0 and k > 0:
            print("Progress: Verified", k, "items")
        k = k + 1
    
    if success:
        print("Map stress test passed!")
    else:
        print("Map stress test failed.")
    
    my_map.drop()
    
    if success:
        return 0
    else:
        return 1
